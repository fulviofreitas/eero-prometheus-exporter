# ============================================================================
# ğŸ§ª Test Release to TestPyPI (Manual Pre-Merge Testing)
# ============================================================================
# Manual workflow to test publishing with development versions BEFORE merging.
# This is separate from the automated TestPyPI publish in release.yml.
#
# Use Case:
#   - Test the build/publish process before merging a PR
#   - Publish dev/rc versions for testing (e.g., 1.0.0.dev0, 1.0.0.rc1)
#   - Validate package installation works correctly
#
# Usage:
#   1. Go to Actions â†’ ğŸ§ª Test Release
#   2. Click "Run workflow"
#   3. Add a version suffix (e.g., "dev1", "rc1", "a1")
#   4. Verify package at https://test.pypi.org/project/eero-prometheus-exporter/
#
# Note: This uses the same testpypi environment as the release workflow.
# ============================================================================

name: ğŸ§ª Test Release

on:
  workflow_dispatch:
    inputs:
      version_suffix:
        description: "Version suffix (e.g., dev0, rc1, a1) - appended to current version"
        required: false
        default: "dev0"
        type: string
      dry_run:
        description: "ğŸ§ª Dry-run mode (build only, no upload)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

concurrency:
  group: test-release
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write  # Required for Trusted Publishing

jobs:
  # ============================================================================
  # ğŸ§ª Publish to TestPyPI
  # ============================================================================
  test-publish:
    name: ğŸ§ª Publish to TestPyPI
    runs-on: ubuntu-latest
    timeout-minutes: 10

    environment:
      name: testpypi
      url: https://test.pypi.org/project/eero-prometheus-exporter/

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: ğŸ Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: ğŸ·ï¸ Determine test version
        id: version
        run: |
          # Read current version from VERSION file or pyproject.toml
          if [ -f VERSION ]; then
            CURRENT_VERSION=$(cat VERSION)
          else
            CURRENT_VERSION=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml)
          fi

          SUFFIX="${{ github.event.inputs.version_suffix }}"

          if [ -n "$SUFFIX" ]; then
            TEST_VERSION="${CURRENT_VERSION}.${SUFFIX}"
          else
            TEST_VERSION="${CURRENT_VERSION}"
          fi

          echo "version=${TEST_VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Test version: ${TEST_VERSION}"

      - name: ğŸ”§ Update version for test release
        run: |
          TEST_VERSION="${{ steps.version.outputs.version }}"

          # Update pyproject.toml
          sed -i "s/^version = \"[^\"]*\"/version = \"${TEST_VERSION}\"/" pyproject.toml

          # Update __init__.py
          sed -i "s/__version__ = \"[^\"]*\"/__version__ = \"${TEST_VERSION}\"/" src/eero_exporter/__init__.py

          echo "âœ… Updated version to ${TEST_VERSION}"
          grep "^version" pyproject.toml

      - name: ğŸ“¦ Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: ğŸ—ï¸ Build package
        run: python -m build

      - name: ğŸ” Validate package
        run: twine check dist/*

      - name: ğŸ“¤ Publish to TestPyPI
        if: github.event.inputs.dry_run != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          skip-existing: true
          attestations: false
          verbose: true

      - name: ğŸ§ª Test installation
        if: github.event.inputs.dry_run != 'true'
        run: |
          TEST_VERSION="${{ steps.version.outputs.version }}"

          echo "â³ Waiting for package to be available on TestPyPI..."
          sleep 30

          echo "ğŸ“¥ Installing from TestPyPI..."
          pip install --index-url https://test.pypi.org/simple/ \
                      --extra-index-url https://pypi.org/simple/ \
                      "eero-prometheus-exporter==${TEST_VERSION}" || {
            echo "âš ï¸ Package not yet available, this is normal for first-time publishes"
            exit 0
          }

          echo "âœ… Package installed successfully"
          python -c "import eero_exporter; print(f'eero-prometheus-exporter version: {eero_exporter.__version__}')"

      - name: ğŸ“ Generate instructions
        if: always()
        run: |
          TEST_VERSION="${{ steps.version.outputs.version }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ğŸ§ª TestPyPI Release Summary

          | Property | Value |
          |:---------|:------|
          | ğŸ“¦ Package | \`eero-prometheus-exporter\` |
          | ğŸ·ï¸ Version | \`${TEST_VERSION}\` |
          | ğŸ¯ Registry | TestPyPI |

          EOF

          if [ "$DRY_RUN" != "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ### ğŸ“¥ Test Installation

          \`\`\`bash
          pip install --index-url https://test.pypi.org/simple/ \\
                      --extra-index-url https://pypi.org/simple/ \\
                      eero-prometheus-exporter==${TEST_VERSION}
          \`\`\`

          > **Note**: \`--extra-index-url\` is needed because dependencies (prometheus-client, typer, etc.)
          > are not available on TestPyPI.

          ### âœ… Next Steps

          1. Verify the package works correctly
          2. Check the [TestPyPI page](https://test.pypi.org/project/eero-prometheus-exporter/)
          3. If everything looks good, merge to master for production release

          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF

          > [!NOTE]
          > ### ğŸ§ª Dry-Run Mode
          > Package was built but not uploaded. Check the build artifacts above.

          EOF
          fi
