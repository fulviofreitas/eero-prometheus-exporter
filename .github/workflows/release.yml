# ============================================================================
# ðŸš€ Automated Semantic Release
# ============================================================================
# Automatically creates releases based on conventional commit messages.
# Generates changelogs, bumps versions, and creates GitHub releases.
#
# Chain: CI â†’ Release â†’ Docker
# Triggers: After CI Pipeline succeeds on main/master
# ============================================================================

name: ðŸš€ Release

on:
  # Trigger after CI workflow completes successfully
  workflow_run:
    workflows: ["ðŸ§ª CI Pipeline"]
    types: [completed]
    branches: [main, master]
  # Allow manual trigger for debugging
  workflow_dispatch:
    inputs:
      dry_run:
        description: "ðŸ§ª Dry-run mode (no actual release)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

# Prevent concurrent releases
concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ============================================================================
  # ðŸš€ Semantic Release
  # ============================================================================
  release:
    name: ðŸš€ Semantic Release
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Only run if CI passed (or manual trigger) and not a release commit
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event.workflow_run.conclusion == 'success' &&
      !contains(github.event.workflow_run.head_commit.message, '[skip ci]') &&
      !contains(github.event.workflow_run.head_commit.message, 'chore(release)'))

    outputs:
      released: ${{ steps.check-release.outputs.released }}
      version: ${{ steps.check-release.outputs.version }}

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: ðŸ“¦ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ”§ Install semantic-release
        run: |
          npm install -g \
            semantic-release@24 \
            @semantic-release/changelog@6 \
            @semantic-release/git@10 \
            @semantic-release/exec@6 \
            conventional-changelog-conventionalcommits@8

      - name: ðŸš€ Run semantic-release
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          if [ "$DRY_RUN" = "true" ]; then
            echo "ðŸ§ª Running in dry-run mode..."
            semantic-release --dry-run
          else
            semantic-release
          fi

      - name: ðŸ” Check if release was created
        id: check-release
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION)
            echo "released=true" >> $GITHUB_OUTPUT
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "âœ… Release v${VERSION} was created"
          else
            echo "released=false" >> $GITHUB_OUTPUT
            echo "version=" >> $GITHUB_OUTPUT
            echo "ðŸ“­ No release created"
          fi

      - name: ðŸ“ Generate release summary
        if: always()
        run: |
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ Release Summary

          EOF

          if [ "$DRY_RUN" = "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          > [!NOTE]
          > ### ðŸ§ª Dry-Run Mode
          > No actual release was created. This was a simulation run.

          EOF
          fi

          if [ -f VERSION ]; then
            VERSION=$(cat VERSION)
            if [ "$DRY_RUN" = "true" ]; then
              cat >> $GITHUB_STEP_SUMMARY << EOF
          ### ðŸ“‹ Would Release

          | Property | Value |
          |:---------|:------|
          | ðŸ·ï¸ Version | \`v${VERSION}\` |
          | ðŸ“ Changelog | Would be updated |
          | ðŸ³ Docker | Would trigger build |

          EOF
            else
              cat >> $GITHUB_STEP_SUMMARY << EOF
          > [!TIP]
          > ### âœ… Release Created Successfully
          > Version \`v${VERSION}\` has been published!

          ### ðŸ“‹ Release Details

          | Property | Value |
          |:---------|:------|
          | ðŸ·ï¸ Version | \`v${VERSION}\` |
          | ðŸ“ Changelog | Updated |
          | ðŸ”— Release | [View Release](../../releases/tag/v${VERSION}) |
          | ðŸ³ Docker | Build triggered automatically |

          EOF
            fi
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          > [!NOTE]
          > ### ðŸ“­ No Release Created
          > No releasable changes detected since the last release.
          >
          > Commits must follow [Conventional Commits](https://conventionalcommits.org) to trigger releases:
          > - `feat:` â†’ Minor release (1.0.0 â†’ 1.1.0)
          > - `fix:` â†’ Patch release (1.0.0 â†’ 1.0.1)
          > - `feat!:` or `BREAKING CHANGE:` â†’ Major release (1.0.0 â†’ 2.0.0)

          EOF
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ### âš™ï¸ Workflow Chain

          \`\`\`
          ðŸ§ª CI Pipeline  â”€â”€â†’  ðŸš€ Release  â”€â”€â†’  ðŸ³ Docker Build
               âœ…                  âœ…              (on tag)
          \`\`\`

          ### ðŸ“Œ Trigger Information

          | Property | Value |
          |:---------|:------|
          | ðŸ“Œ Event | \`${{ github.event_name }}\` |
          | ðŸŒ¿ Branch | \`${{ github.ref_name }}\` |
          | ðŸ”— Commit | \`${{ github.sha }}\` |

          ---

          <sub>ðŸ¤– Powered by semantic-release</sub>
          EOF
